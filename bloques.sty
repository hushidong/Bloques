%  bloques.sty
%       package based on tikz for control diagrams in power electronics.
%       version 1.0
% 	    author:  Alejandro Garces
%		            alejandrogarces@gmail.com
%       updated 2021-12-28 by hu zhenzhen (hzzmail@163.com)
%           * add new some commands for feed forward drawing
%           * add more instructions of cmds in the doc
% License: LPPL
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.

%增加double，线型的控制
%了解anckor
%readme中增加示例图片

\usepackage{tikz}
\usepgflibrary{shapes.misc,arrows,arrows.meta}%
\usetikzlibrary{calc,bending,decorations.pathmorphing,backgrounds,positioning,fit,shadows}

\newcommand{\xdistancia}{1.5cm} %x方向平移距离
\newcommand{\ydistancia}{1.2cm} %y方向平移距离
\newcommand{\minaltura}{0.7cm} %节点的最小高度
\newcommand{\tamano}{\footnotesize} %字体大小
\newcommand{\colorfondo}{white} %背景颜色
\newcommand{\colortexto}{black} %文本颜色
\newcommand{\sombra}{0} %阴影的程度
\newcommand{\blinkwd}{0.8pt} %线宽，line width
\newcommand{\ancholinea}{thick} %节点线的宽度
\newcommand{\colorlinea}{black} %连线的颜色
\newcommand{\blinkstyle}{thick} %连线的样式
\newcommand{\barrowstyle}{-latex}%连线的箭头，如：latex,stealth,Stealth[open,bend,sep]

%参数重设的命令
\newcommand{\bShadow}{\renewcommand{\sombra}{1}}
\newcommand{\bColorB}[1]{\renewcommand{\colorfondo}{#1}}
\newcommand{\bColorT}[1]{\renewcommand{\colortexto}{#1}}
\newcommand{\bColorL}[1]{\renewcommand{\colorlinea}{#1}}
\newcommand{\bLineL}[1]{\renewcommand{\blinkstyle}{#1}}
\newcommand{\bArrow}[1]{\renewcommand{\barrowstyle}{#1}}
\newcommand{\ydistance}[1]{\renewcommand{\ydistancia}{#1}}
\newcommand{\restoreydis}{\renewcommand{\ydistancia}{1.2cm}}
\newcommand{\xdistance}[1]{\renewcommand{\xdistancia}{#1}}
\newcommand{\restorexdis}{\renewcommand{\xdistancia}{1.5cm}}


%各元素块
\newcommand{\bStart}[1]{\node [] (NODO1) {\tamano{#1}};}

\newcommand{\bPlusDown}[1]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (SUMA) {};
\node [draw=gray!50, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, thin] {};	
\node [left of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [below of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\draw [\barrowstyle,\colorlinea,\blinkstyle] (NODO1) -- (SUMA);	
\node [below of = SUMA, node distance =  \ydistancia] (VARIABLE) {\tamano{#1}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (VARIABLE) -- (SUMA);			
\node  at (SUMA) [anchor = west] (NODO1) {};	
}


\newcommand{\bPlusUp}[1]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,
        \ancholinea, fill=\colorfondo,drop shadow={opacity=\sombra}] (SUMA) {};
\node [draw=gray!50, cross out, minimum size=1.0em, right of=NODO1, node distance=\xdistancia,thin] {};	
\node [left of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [above of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (SUMA);	
\node [above of = SUMA, node distance =  \ydistancia] (VARIABLE) {\tamano{#1}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (VARIABLE) -- (SUMA);			
\node  at (SUMA) [anchor = west] (NODO1) {};	
}


\newcommand{\bMinusDown}[1]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (SUMA) {};
\node [cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia,  thin, draw=gray!50] {};	
\node [left of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [below of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$-$}};
\draw [\barrowstyle,\colorlinea,\blinkstyle] (NODO1) -- (SUMA);	
\node [below of = SUMA, node distance =  \ydistancia] (VARIABLE) {\tamano{#1}};
\draw [\barrowstyle,\colorlinea,\blinkstyle] (VARIABLE) -- (SUMA);			
\node  at (SUMA) [anchor = west] (NODO1) {};
}


\newcommand{\bMinusUp}[1]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (SUMA) {};
\node [thin, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, draw=gray!50] {};	
\node [left of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [above of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$-$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (SUMA);	
\node [above of = SUMA, node distance =  \ydistancia] (VARIABLE) {\tamano{#1}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (VARIABLE) -- (SUMA);			
\node  at (SUMA) [anchor = west] (NODO1) {};
}

\newcommand{\bEnd}[1]{
\node [right of = NODO1, node distance = 1.7cm] (F) {\tamano{#1}};
\draw [\barrowstyle,\colorlinea,\blinkstyle] (NODO1) -- (F);
\node  at (F) [anchor = west] (NODO1) {};
}


\newcommand{\bInter}[1]{
\coordinate (NODO2) at ($(NODO1)+(\xdistancia,0)$) node[above] at (NODO2) {\color{\colortexto}\tamano{#1}};		
\draw [\colorlinea,\blinkstyle] (NODO1)--(NODO2);
\node[inner sep=0pt,minimum size=0pt]  at (NODO2.center) [anchor = center] (NODO1) {};%
}

\newcommand{\bMarkNodeInter}[1]{
    \node[inner sep=0pt,minimum size=0pt] at (NODO1.center) [anchor = center] (#1) {};
}

\newcommand{\bFeedForward}[3]{		
\node [draw=\colorlinea, rectangle, above right of = #2, minimum height =\minaltura,\ancholinea,
node distance= \xdistancia and \ydistancia, fill=\colorfondo,drop shadow={opacity=\sombra},
anchor = west] (NODOG) {\color{\colortexto}\tamano{#1}};	
\draw [\barrowstyle, \colorlinea,\blinkstyle] (#2) |- (NODOG);
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODOG) -| (#3);     	
}


\newcommand{\bGain}[2][]{		
\node [draw=\colorlinea, rectangle, right of = NODO1, node distance= \xdistancia, minimum height = \minaltura,
       \ancholinea, fill=\colorfondo,drop shadow={opacity=\sombra}] (NODO2) {\color{\colortexto}\tamano{#2}};	
\draw [\colorlinea,\blinkstyle] (NODO1)--node[above] {\tamano{#1}} (NODO2);
\node  at (NODO2.east) [anchor = east] (NODO1) {};
}


\newcommand{\bGainPlus}[2]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (SUMA) {};
\node [thin, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, draw=gray!50] {};	
\node [left of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [below of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (SUMA);	
\node [draw=\colorlinea, rectangle, below of = SUMA, node distance =  \xdistancia,xshift=-0.3cm, minimum height = \minaltura,\ancholinea,
     fill=\colorfondo,drop shadow={opacity=\sombra}, anchor = east] (NODOG) {\color{\colortexto}\tamano{#2}};
\node [left of = NODOG, node distance =  \xdistancia] (VARIABLE) {\tamano{#1}};  	
\draw [\barrowstyle, \colorlinea,\blinkstyle] (VARIABLE) -- (NODOG);
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODOG) -| (SUMA);			
\node  at (SUMA) [anchor = west] (NODO1) {};
}

\newcommand{\bGainMinus}[2]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (SUMA) {};
\node [thin, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, draw=gray!50] {};	
\node [left of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [below of = SUMA, node distance = 0.45em] () { \color{\colortexto}\tiny{$-$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (SUMA);	
\node [draw=\colorlinea, rectangle, below of = SUMA, node distance =  \xdistancia,xshift=-0.3cm, minimum height = \minaltura,\ancholinea,
     fill=\colorfondo,drop shadow={opacity=\sombra}, anchor = east] (NODOG) {\color{\colortexto}\tamano{#2}};
\node [left of = NODOG, node distance =  \xdistancia] (VARIABLE) {\tamano{#1}};  	
\draw [\barrowstyle, \colorlinea,\blinkstyle] (VARIABLE) -- (NODOG);
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODOG) -| (SUMA);			
\node  at (SUMA) [anchor = west] (NODO1) {};
}


\newcommand{\bMinusF}[2][]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (#2) {};
\node [cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, thin, draw=gray!50] {};	
\node [left of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [below of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$-$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (#2);			
\node  at (#2) [anchor = west] (NODO1) {};	
}


\newcommand{\bPlusF}[2][]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (#2) {};
\node [thin, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, draw=gray!50] {};	
\node [left of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [below of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (#2);			
\node  at (#2) [anchor = west] (NODO1) {};	
}

\newcommand{\bPlus}[2][]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (#2) {};
\node [draw=gray!50, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, thin] {};	
\node [left of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [above of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (#2);	
\node  at (#2) [minimum size=1.5em] (NODO1) {};	%anchor = west
}

\newcommand{\bMinus}[2][]{
\node [draw=\colorlinea, circle,minimum size=1.5em, right of=NODO1, node distance= \xdistancia,\ancholinea, fill=\colorfondo,
       drop shadow={opacity=\sombra}] (#2) {};
\node [thin, cross out, minimum size=1.0em, right of=NODO1, node distance= \xdistancia, draw=gray!50] {};	
\node [left of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$+$}};
\node [above of = #2, node distance = 0.45em] () { \color{\colortexto}\tiny{$-$}};
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- (#2);	
\node  at (#2) [minimum size=1.5em] (NODO1) {};
}

\newcommand{\bFeedBack}[2]{		
\node [draw=\colorlinea, rectangle, below left of = NODO1, node distance =  \ydistancia, minimum height = \minaltura,\ancholinea,
     fill=\colorfondo,drop shadow={opacity=\sombra}, anchor = west] (NODOG) {\color{\colortexto}\tamano{#1}};	
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1) -- +(0.5,0) |- (NODOG);
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODOG) -| (#2);     	
}

\newcommand{\bFeedBackvhv}[2]{		
\node [draw=\colorlinea, rectangle, below left of = NODO1, node distance =  \ydistancia, minimum height = \minaltura,\ancholinea,
     fill=\colorfondo,drop shadow={opacity=\sombra}, anchor = west] (NODOG) {\color{\colortexto}\tamano{#1}};	
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODO1.south) |- (NODOG);
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODOG) -| (#2);     	
}

\newcommand{\bCrossGain}[3]{		
\node [draw=\colorlinea, rectangle, above right of = #2, minimum height = \minaltura,\ancholinea,
     fill=\colorfondo,drop shadow={opacity=\sombra}, anchor = west] (NODOG) {\color{\colortexto}\tamano{#1}};	
\draw [\barrowstyle, \colorlinea,\blinkstyle] (#2) |- (NODOG);
\draw [\barrowstyle, \colorlinea,\blinkstyle] (NODOG) -| (#3);     	
}

\newcommand{\bNewStart}[2]{
	\node at #2 (NODO1) {\tamano{#1}};
}

\newcommand{\bNewInter}[2]{
	\node [inner sep=0pt,minimum size=0mm,
	       \ancholinea,drop shadow={opacity=\sombra}] at #2
        [anchor = center] (NODO1) {\color{\colortexto}\tamano{#1}};	
}

\newcommand{\bLink}[2]{
    \draw[\barrowstyle,\colorlinea,\blinkstyle] (#1) -- (#2);
}

\newcommand{\bLinkvh}[2]{
    \draw[\barrowstyle,\colorlinea,\blinkstyle] (#1) |- (#2);
}

\newcommand{\bLinkhv}[2]{
    \draw[\barrowstyle,\colorlinea,\blinkstyle] (#1) -| (#2);
}


\newcommand{\bMarkNode}[1]{
	\node at (NODO1) (#1) {};
}

\newcommand{\bMarkNodeUp}[1]{
	\node[above of = NODO1, node distance =  \ydistancia] (#1) {};
}

\newcommand{\bMarkNodeDown}[1]{
	\node[below of = NODO1,node distance =  \ydistancia] (#1) {};
}
